<!DOCTYPE html>
<html>
<!-- This template originally from https://www.w3schools.com/css/css_rwd_templates.asp
or more specifically https://www.w3schools.com/w3css/tryit.asp?filename=tryw3css_templates_clothing_store&stacked=h
-->
<title>TM Card Maker</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="tm_cm.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
<style>
.w3-sidebar a {font-family: "Roboto", sans-serif}
body,h1,h2,h3,h4,h5,h6,.w3-wide {font-family: "Montserrat", sans-serif;}
</style>
<body>
  <div class="overlay w3-nodisplay" id="overlay">
    <div class="centerme">
      <div class="w3-white" style="padding: 50px;">
        Enter url to load image from:
        <input id="url2load" type="url">
        <button onclick="cancelOverlay()">Cancel</button>
        <button onclick="loadWebImage()">Load</button>
      </div>
    </div>
  </div>
  <div class="overlay w3-nodisplay" id="fontoverlay">
    <div class="centerme">
      <div class="w3-white" style="padding: 50px;">
        Enter url to load font from:
        <input id="fonturl2load" type="text">
        <button onclick="cancelFontOverlay()">Cancel</button>
        <button onclick="loadSpecifiedFont()">Load</button>
      </div>
    </div>
  </div>
<!-- Sidebar/menu -->
<nav class="w3-sidebar w3-bar-block w3-white w3-collapse w3-top" style="z-index:3;width:180px" id="mySidebar">
  <div class="w3-large w3-text-grey" style="font-weight:bold">
    <a class="w3-button w3-block w3-light-grey" href="https://github.com/santororock/tm_cardmaker" target="_blank" rel="noopener noreferrer"><div style="font-size: 0.75em;">TM Cardmaker GitHub Project</div></a>
    <a onclick="myAccFunc('file')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
      File <i class="fa fa-caret-down"></i>
    </a>
    <div id="file" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      <a onclick="clickNew()" href="#" class="w3-bar-item w3-button">New</a>
      <a onclick="myAccFunc('fromTemplate')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
        New from Template <i class="fa fa-caret-down"></i>
      </a>
      <div id="fromTemplate" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
        <!-- <a href="#" class="w3-bar-item w3-button">Load</a> -->
      <a onclick="saveProjectCont(false)" href="#" class="w3-bar-item w3-button">Save</a>
      <a onclick="clickLoadNewProject()" href="#" class="w3-bar-item w3-button">Clear &amp; Load Project</a>
      <a onclick="clickLoadProject()" href="#" class="w3-bar-item w3-button">Load Project</a>
      <a onclick="clickSaveProject()" href="#" class="w3-bar-item w3-button">Save as Project</a>
    </div>
    <a onclick="myAccFunc('design')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
      Add Block <i class="fa fa-caret-down"></i>
    </a>
    <div id="design" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      <a onclick="myAccFunc('backgrounds')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
        User Images <i class="fa fa-caret-down"></i>
      </a>
      <div id="backgrounds" class="w3-bar-block w3-hide w3-padding-large w3-medium">
        <a onclick="clickLoadWebImage()" href="#" class="w3-bar-item w3-button">Load Web Image</a>
        <a onclick="document.getElementById('fileselection').click()" href="#" class="w3-bar-item w3-button">Load Local Image</a>
        <input type="file" id="fileselection" class="w3-hide" onchange="addUserFile(this)">
        <!-- <a onclick="addColor()" href="#" class="w3-bar-item w3-button">Set Color</a> -->
      </div>
      <a onclick="clickLoadFont()" href="#" class="w3-bar-item w3-button">Add Web Font</a>
      <a onclick="addTextBox()" href="#" class="w3-bar-item w3-button">Text box</a>
      <a onclick="addProduction()" href="#" class="w3-bar-item w3-button">Production box</a>
      <a onclick="addEffectBox()" href="#" class="w3-bar-item w3-button">Effect box</a>
      <a onclick="addLine()" href="#" class="w3-bar-item w3-button">Line</a>
      <a onclick="myAccFunc('templates')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
        Templates <i class="fa fa-caret-down"></i>
      </a>
      <div id="templates" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
      <a onclick="myAccFunc('tags')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
        Tags <i class="fa fa-caret-down"></i>
      </a>
      <div id="tags" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
      <a onclick="myAccFunc('globalparameters')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
        Global Params <i class="fa fa-caret-down"></i>
      </a>
      <div id="globalparameters" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
      <a onclick="myAccFunc('misc')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
       Misc <i class="fa fa-caret-down"></i>
     </a>
     <div id="misc" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
      <a onclick="myAccFunc('parties')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
       Parties <i class="fa fa-caret-down"></i>
     </a>
     <div id="parties" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
      <a onclick="myAccFunc('requisites')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
       Requirements <i class="fa fa-caret-down"></i>
     </a>
     <div id="requisites" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
      <a onclick="myAccFunc('resources')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
       Resources <i class="fa fa-caret-down"></i>
     </a>
     <div id="resources" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
      <a onclick="myAccFunc('tiles')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
       Tiles <i class="fa fa-caret-down"></i>
     </a>
     <div id="tiles" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
      <a onclick="myAccFunc('VPs')" href="javascript:void(0)" class="w3-button w3-block w3-white w3-left-align">
       VPs <i class="fa fa-caret-down"></i>
     </a>
     <div id="VPs" class="w3-bar-block w3-hide w3-padding-large w3-medium">
      </div>
    </div>
  </div>
  
</nav>

<!-- Sidebar Resize Handle -->
<div id="sidebarResizeHandle"></div>

<!-- Top menu on small screens -->
<header class="w3-bar w3-top w3-hide-large w3-black w3-xlarge">
  <a href="javascript:void(0)" class="w3-bar-item w3-button w3-padding-24 w3-right" onclick="w3_open()">
    <div class="fa-bars"></div><div class="fa-bars"></div><div class="fa-bars"></div></i></a>
</header>

<!-- Overlay effect when opening sidebar on small screens -->
<div class="w3-overlay w3-hide-large" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

<!-- !PAGE CONTENT! -->
<div class="w3-main">

  <!-- Push down content on small screens -->
  <div class="w3-hide-large" style="margin-top:83px"></div>

  <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
    <div id="loadprogress">
      <label for="files">Loading images:</label>
      <progress id="files" value="0" max="100"></progress>
      <div id="fontload">
        <div style="font-family: Prototype;">Prototype</div>
        <div style="font-family: Pagella;">Palatino-like</div>
        <div style="font-family: 'Times New Roman';">Times New Roman</div>
      </div>
    </div>

    <!-- Canvas Container with Zoom Controls -->
    <div id="canvasContainer">
      <div id="zoomControls">
        <button onclick="zoomCanvasOut()">âˆ’</button>
        <button onclick="zoomCanvasReset()">Reset</button>
        <button onclick="zoomCanvasIn()">+</button>
        <span id="zoomLevel">100%</span>
      </div>
      <div id="canvasScrollarea">
        <div id="canvasScrollinner">
          <div id="canvaswrap" style="position:relative;">
            <canvas id="cmcanvas" height="1050px" width="750px" style="border:1px solid #101010; display:block;"></canvas>
            <canvas id="cmcanvas_overlay" class="debug-overlay-canvas"></canvas>
          </div>
        </div>
      </div>
    </div>

    <a id="projectlink"></a>
    <div id="xcanvases" width="100%" style="display: none;"></div>

    <!-- Properties Panel Resize Handle -->
    <div id="paramsResizeHandle"></div>

    <!-- Right Sidebar Panel - Contains debug controls and layer list -->
    <div id="rightPanel" style="position: fixed; right: 0; top: 0; width: 340px; height: 100vh; overflow-y: auto; background: white; border-left: 1px solid #ddd; padding: 16px; z-index: 200; box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);">
      <!-- Debug Controls -->
      <div id="debugcontrols" style="margin-bottom:8px;">
        <label style="white-space:nowrap;"><input id="debugBounds" type="checkbox" onchange="window.debugOverlay && window.debugOverlay.toggle(this.checked)"> Debug bounds</label>
        <select id="debugMode" onchange="window.debugOverlay && window.debugOverlay.setMode(this.value)">
          <option value="selected">Selected</option>
          <option value="all">All</option>
        </select>
        <div id="debuglegend" class="debug-legend">
          <span class="legend-item"><span class="legend-swatch swatch-mask"></span> clickable mask</span>
          <span class="legend-item"><span class="legend-swatch swatch-tainted"></span> mask unavailable (tainted)</span>
          <span class="legend-item"><span class="legend-swatch swatch-rect"></span> logical rect</span>
          <span class="legend-item"><span class="legend-swatch swatch-cross"></span> origin</span>
        </div>
      </div>
      
      <!-- Layer List - params will be appended inside selected layer -->
      <section id="layerlist"></section>
      
      <span class="w3-padding-16"><input id="groupmode" type="checkbox" onchange="groupModeToggle()" class="w3-show-inline-block" >Group Mode</span>
      <button onclick="copyToClipboard()" style="display: none;" >Copy</button>
      
      <hr>
      
      <!-- Settings -->
      <div id="settings">
        <b>Settings</b><br>
        <span style="float: right;">Max Undo Steps:<input id="inputmaxundosteps" type="number" min="5" max="500" value="50" onchange="updateMaxUndoSteps(this)"></span><br>
      </div>
    </div>

    <!-- Properties sections - will be moved into selected layer by JavaScript -->
    <div id="params">
    <div id="allpreset">
      <span style="float: right;">Presets:<select id="presets" type="select" onchange="setPresets(this)">
        <option value="" default>Select...</option>
        <option value="defselect0"></option>
        <option value="defselect1"></option>
      </select></span><br>
    </div>
    <div id="allall">
      <span style="float: right;">X:<input id="inputx" type="number" onchange="updateValue(this)"></span><br>
      <span style="float: right;">Y:<input id="inputy" type="number" onchange="updateValue(this)"></span><br>
      <span style="float: right;">width:<input id="inputwidth" type="number" min="1" onchange="updateValue(this)"></span><br>
    </div>
    <div id="allimages">
      <span style="float: right;">Lock aspect ratio:<input id="lar" type="checkbox" onchange="updateValue(this)" checked></span><br>
      <span style="float: right;">height:<input id="inputheight" type="number" min="1" onchange="updateValue(this)"></span><br>
    </div>
    <div id="allangle">
      <span style="float: right;">Angle:<input id="inputangle" type="number" min="0" max="359" onchange="updateValue(this)"></span><br>
    </div>
    <div id="alllen">
      <span style="float: right;">Length:<input id="inputlen" type="number" min="1" onchange="updateValue(this)"></span><br>
    </div>
    <div id="clipimages">
      <span style="float: right;">Opacity:<input id="inputalpha" type="number" min="0" max="100" onchange="updateValue(this)">%</span><br>
      <span style="float: right;">sX:<input id="inputsx" type="number" min="0" onchange="updateValue(this)"></span><br>
      <span style="float: right;">sY:<input id="inputsy" type="number" min="0" onchange="updateValue(this)"></span><br>
      <span style="float: right;">swidth:<input id="inputswidth" type="number" min="1" onchange="updateValue(this)"></span><br>
      <span style="float: right;">Lock aspect ratio:<input id="slar" type="checkbox" onchange="updateValue(this)" checked></span><br>
      <span style="float: right;">sheight:<input id="inputsheight" type="number" min="1" onchange="updateValue(this)"></span><br>
    </div>
    <div id="otherbg">
      <span>'Others' background:<input id="inputobg" type="checkbox" onchange="updateValue(this)"></span><br>
    </div>
    <div id="alltext">
      <span style="float: right;"><textarea id="inputdata" cols="17" onchange="updateValue(this)"></textarea></span><br>
      <span style="float: right;">V space:<input id="inputlineSpace" type="number" onchange="updateValue(this)"></span><br>
      <span style="float: right;">Font:<select id="inputfont" type="select" onchange="updateValue(this)">
        <option value="Prototype" style="font-family: Prototype;" default>Prototype</option>
        <option value="Pagella" style="font-family: Pagella;">Palatino-like</option>
        <option value="times" style="font-family: 'Times New Roman';">Times New Roman</option>
      </select></span><br>
      <span style="float: right;">Style:<select id="inputstyle" type="select" onchange="updateValue(this)">
        <option value="normal" default>Normal</option>
        <option value="italic">Italic</option>
      </select></span><br> 
      <span style="float: right;">Weight:<select id="inputweight" type="select" onchange="updateValue(this)">
        <option value="normal" default>Normal</option>
        <option value="bold">Bold</option> 
      </select></span><br>
      <span style="float: right;">Justify:<select id="inputjustify" type="select" onchange="updateValue(this)">
        <option value="center" default>Center</option>
        <option value="left">Left</option>
        <option value="right">Right</option>
      </select></span><br>
    </div>
    <div id="color">
      <span style="float: right;">Color:<input id="inputcolor" type="color" onchange="updateValue(this)"></span>
      <!-- <span style="float: right;">Red</label><input type="range" id="inputred" min="0" max="255" value="255" onchange="updateValue(this)"></span><br>
      <span style="float: right;">Green</label><input type="range" id="inputgreen" min="0" max="255" value="255" onchange="updateValue(this)"></span><br>
      <span style="float: right;">Blue</label><input type="range" id="inputblue" min="0" max="255" value="255" onchange="updateValue(this)"></span> -->
    </div>
    <hr>
    <div id="settings">
      <b>Settings</b><br>
      <span style="float: right;">Max Undo Steps:<input id="inputmaxundosteps" type="number" min="5" max="500" value="50" onchange="updateMaxUndoSteps(this)"></span><br>
    </div>
  </div>

  <!-- End page content -->
</div>

<script src="imageFit.js"></script>

<!-- Canvas Zoom & Scroll Script -->
<script>
  // Canvas zoom and scroll functionality
  let canvasZoom = 1;
  const zoomStep = 0.1;
  const minZoom = 0.25;
  const maxZoom = 3;
  const canvaswrap = document.getElementById('canvaswrap');
  const canvasScrollarea = document.getElementById('canvasScrollarea');
  const canvasScrollinner = document.getElementById('canvasScrollinner');
  const zoomLevelDisplay = document.getElementById('zoomLevel');

  // Center the canvas in the visible viewport
  function centerCanvas() {
    console.log("[HTML] centerCanvas called at", Date.now());
    console.log("[HTML] Call stack:", new Error().stack);
    if (canvasScrollinner && canvasScrollarea) {
      // Use setTimeout to ensure DOM has fully rendered
      setTimeout(() => {
        console.log("[HTML] centerCanvas setTimeout executing at", Date.now());
        // Since the canvas is centered in #canvasScrollinner via flexbox,
        // we just need to scroll to the center of the scrollable area
        const scrollWidth = canvasScrollarea.scrollWidth;
        const scrollHeight = canvasScrollarea.scrollHeight;
        const viewportWidth = canvasScrollarea.clientWidth;
        const viewportHeight = canvasScrollarea.clientHeight;
        
        console.log("[HTML] scrollWidth:", scrollWidth, "viewportWidth:", viewportWidth);
        console.log("[HTML] Before - scrollLeft:", canvasScrollarea.scrollLeft, "scrollTop:", canvasScrollarea.scrollTop);
        
        // Center the scrollable content in the viewport
        const scrollX = (scrollWidth - viewportWidth) / 2;
        const scrollY = (scrollHeight - viewportHeight) / 2;
        
        canvasScrollarea.scrollLeft = scrollX;
        canvasScrollarea.scrollTop = scrollY;
        
        console.log("[HTML] After - scrollLeft:", canvasScrollarea.scrollLeft, "scrollTop:", canvasScrollarea.scrollTop);
      }, 100);
    }
  }

  // Always start at default zoom on page load
  canvasScrollinner.style.transform = 'scale(1)';
  zoomLevelDisplay.textContent = '100%';
  
  // Make centerCanvas globally accessible so it can be called after autosave loads
  window.centerCanvas = centerCanvas;
  console.log("[HTML] window.centerCanvas set to HTML version");
  
  // Make zoomCanvasReset accessible for initial zoom-to-fit
  window.zoomToFitAndCenter = function() {
    console.log("[HTML] zoomToFitAndCenter called - will be overridden by zoomCanvasReset");
  };
  
  // On page load, we'll call zoomCanvasReset from JS after it's defined
  // For now, just center at default zoom
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      // The JS file will override this and call zoomCanvasReset instead
      if (window.zoomToFitAndCenter) {
        window.zoomToFitAndCenter();
      }
    });
  } else {
    if (window.zoomToFitAndCenter) {
      window.zoomToFitAndCenter();
    }
  }

  function updateCanvasZoom(mouseX, mouseY) {
    const oldZoom = canvasZoom;
    
    // If mouse position is provided, zoom to that point
    if (mouseX !== undefined && mouseY !== undefined) {
      const scrollArea = canvasScrollarea;
      const rect = scrollArea.getBoundingClientRect();
      
      // Get mouse position relative to scroll area viewport
      const viewportX = mouseX - rect.left;
      const viewportY = mouseY - rect.top;
      
      // Calculate the point in the content before zoom (using the OLD zoom value)
      const contentX = scrollArea.scrollLeft + viewportX;
      const contentY = scrollArea.scrollTop + viewportY;
      
      // Calculate position in the unscaled canvas
      const canvasX = contentX / oldZoom;
      const canvasY = contentY / oldZoom;
      
      // Apply new zoom
      canvasScrollinner.style.transform = `scale(${canvasZoom})`;
      
      // Calculate where that point should be now with the new zoom
      const newContentX = canvasX * canvasZoom;
      const newContentY = canvasY * canvasZoom;
      
      // Adjust scroll to keep the point under the cursor
      scrollArea.scrollLeft = newContentX - viewportX;
      scrollArea.scrollTop = newContentY - viewportY;
    } else {
      // No mouse position, just zoom normally
      canvasScrollinner.style.transform = `scale(${canvasZoom})`;
    }
    
    zoomLevelDisplay.textContent = Math.round(canvasZoom * 100) + '%';
  }

  function zoomCanvasIn(mouseX, mouseY) {
    const oldZoom = canvasZoom;
    canvasZoom = Math.min(maxZoom, canvasZoom + zoomStep);
    updateCanvasZoom(mouseX, mouseY);
  }

  function zoomCanvasOut(mouseX, mouseY) {
    const oldZoom = canvasZoom;
    canvasZoom = Math.max(minZoom, canvasZoom - zoomStep);
    updateCanvasZoom(mouseX, mouseY);
  }

  function zoomCanvasReset() {
    // Calculate optimal zoom to fit canvas between sidebars
    const sidebar = document.getElementById('mySidebar');
    const rightPanel = document.getElementById('rightPanel');
    const leftSidebarWidth = sidebar ? sidebar.offsetWidth : 0;
    const rightPanelWidth = rightPanel ? rightPanel.offsetWidth : 0;
    
    // Available space for the canvas
    const availableWidth = canvasScrollarea.clientWidth - rightPanelWidth;
    const availableHeight = canvasScrollarea.clientHeight;
    
    // Get the actual canvas dimensions
    const canvas = document.getElementById('cmcanvas');
    const canvasWidth = canvas ? canvas.width : 826;
    const canvasHeight = canvas ? canvas.height : 1126;
    
    // Add some padding (e.g., 5% on each side)
    const paddingFactor = 0.90;
    
    // Calculate zoom ratios for width and height
    const zoomToFitWidth = (availableWidth * paddingFactor) / canvasWidth;
    const zoomToFitHeight = (availableHeight * paddingFactor) / canvasHeight;
    
    // Use the smaller zoom to ensure it fits in both dimensions
    const optimalZoom = Math.min(zoomToFitWidth, zoomToFitHeight);
    
    // Clamp to min/max zoom limits
    canvasZoom = Math.max(minZoom, Math.min(maxZoom, optimalZoom));
    
    console.log("=== Zoom to Fit Debug ===");
    console.log("Available space:", availableWidth, "x", availableHeight);
    console.log("Canvas size:", canvasWidth, "x", canvasHeight);
    console.log("Zoom to fit width:", zoomToFitWidth);
    console.log("Zoom to fit height:", zoomToFitHeight);
    console.log("Optimal zoom:", optimalZoom);
    console.log("Applied zoom:", canvasZoom);
    console.log("========================");
    
    updateCanvasZoom();
    // Center the canvas after zooming
    centerCanvas();
  }

  // Mousewheel zoom (zoom to cursor position)
  canvasScrollarea.addEventListener('wheel', (e) => {
    if (e.ctrlKey || e.metaKey) {
      e.preventDefault();
      if (e.deltaY < 0) {
        zoomCanvasIn(e.clientX, e.clientY);
      } else {
        zoomCanvasOut(e.clientX, e.clientY);
      }
    }
  }, { passive: false });

  // Pan/drag canvas (ctrl + left-click)
  let isPanning = false;
  let startX = 0;
  let startY = 0;
  let scrollLeft = 0;
  let scrollTop = 0;

  canvasScrollarea.addEventListener('mousedown', (e) => {
    // Only pan if ctrl is held and left mouse button
    if (e.ctrlKey && e.button === 0) {
      isPanning = true;
      startX = e.pageX - canvasScrollarea.offsetLeft;
      startY = e.pageY - canvasScrollarea.offsetTop;
      scrollLeft = canvasScrollarea.scrollLeft;
      scrollTop = canvasScrollarea.scrollTop;
      canvasScrollarea.classList.add('grabbing');
      e.preventDefault();
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (!isPanning) return;
    e.preventDefault();
    const x = e.pageX - canvasScrollarea.offsetLeft;
    const y = e.pageY - canvasScrollarea.offsetTop;
    const walkX = (x - startX);
    const walkY = (y - startY);
    canvasScrollarea.scrollLeft = scrollLeft - walkX;
    canvasScrollarea.scrollTop = scrollTop - walkY;
  });

  document.addEventListener('mouseup', () => {
    if (isPanning) {
      isPanning = false;
      canvasScrollarea.classList.remove('grabbing');
    }
  });
</script>

<!-- Sidebar Resize Script -->
<script>
  (function() {
    // LEFT SIDEBAR RESIZE
    const handle = document.getElementById('sidebarResizeHandle');
    const sidebar = document.getElementById('mySidebar');
    const minWidth = 180;
    const maxWidth = 500;
    const storageKey = 'tm_cardmaker_sidebar_width';

    // Load saved width from localStorage
    const savedWidth = localStorage.getItem(storageKey);
    if (savedWidth) {
      setSidebarWidth(parseInt(savedWidth));
    }

    function setSidebarWidth(width) {
      const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, width));
      sidebar.style.width = constrainedWidth + 'px';
      handle.style.left = constrainedWidth + 'px';
      document.documentElement.style.setProperty('--sidebar-width', constrainedWidth + 'px');
      localStorage.setItem(storageKey, constrainedWidth);
    }

    let isResizing = false;
    let startX = 0;
    let startWidth = 0;

    handle.addEventListener('mousedown', (e) => {
      if (window.innerWidth <= 992) return; // Only on desktop
      isResizing = true;
      startX = e.clientX;
      startWidth = parseInt(window.getComputedStyle(sidebar).width);
      handle.classList.add('dragging');
      document.body.style.userSelect = 'none';
      document.body.style.cursor = 'col-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const delta = e.clientX - startX;
      const newWidth = startWidth + delta;
      setSidebarWidth(newWidth);
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        handle.classList.remove('dragging');
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
      }
    });

    // Handle window resize on mobile
    window.addEventListener('resize', () => {
      if (window.innerWidth <= 992) {
        handle.style.display = 'none';
      } else {
        handle.style.display = 'block';
      }
    });
  })();

  // RIGHT PROPERTIES PANEL RESIZE
  (function() {
    const handle = document.getElementById('paramsResizeHandle');
    const rightPanel = document.getElementById('rightPanel');
    const minWidth = 180;
    const maxWidth = 600;
    const storageKey = 'tm_cardmaker_params_width';

    // Load saved width from localStorage
    const savedWidth = localStorage.getItem(storageKey);
    if (savedWidth) {
      setRightPanelWidth(parseInt(savedWidth));
    } else {
      setRightPanelWidth(340);
    }

    function setRightPanelWidth(width) {
      const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, width));
      rightPanel.style.width = constrainedWidth + 'px';
      handle.style.right = constrainedWidth + 'px';
      localStorage.setItem(storageKey, constrainedWidth);
    }

    let isResizing = false;
    let startX = 0;
    let startWidth = 0;

    handle.addEventListener('mousedown', (e) => {
      if (window.innerWidth <= 992) return; // Only on desktop
      isResizing = true;
      startX = e.clientX;
      startWidth = parseInt(window.getComputedStyle(rightPanel).width);
      handle.classList.add('dragging');
      document.body.style.userSelect = 'none';
      document.body.style.cursor = 'col-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const delta = startX - e.clientX; // Note: reversed because we're dragging from the right
      const newWidth = startWidth + delta;
      setRightPanelWidth(newWidth);
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        handle.classList.remove('dragging');
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
      }
    });

    // Handle window resize on mobile
    window.addEventListener('resize', () => {
      if (window.innerWidth <= 992) {
        handle.style.display = 'none';
      } else {
        handle.style.display = 'block';
      }
    });
  })();
</script>

<script src="tm_cm.js"></script>
<script src="tm_debug_overlay.js"></script>

</body>
</html>